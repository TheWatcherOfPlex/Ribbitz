# Ribbits Stat Assistant - Setup & Usage Guide

This system automatically syncs your D&D character stats from Google Sheets to OBS text files in real-time!

---

## üìã Quick Overview

**What it does:**
1. Watches your Google Sheet during gameplay
2. Auto-generates `.txt` files organized by type (identity/core/combat/etc.)
3. OBS reads these files as Text Sources ‚Üí updates live on stream
4. AI can batch-edit JSON ‚Üí push all changes back to sheet at once

**File Structure:**
```
OBS Auto Sync/
  ‚îú‚îÄ‚îÄ ribbits.config.json          (configuration)
  ‚îú‚îÄ‚îÄ mapping.generated.json       (generated by scripts)
  ‚îú‚îÄ‚îÄ service-account.json         (YOU CREATE THIS - see Step 1)
  ‚îú‚îÄ‚îÄ Engine/
  ‚îÇ   ‚îú‚îÄ‚îÄ RibbitsStatAssistant.ps1 (main watcher)
  ‚îÇ   ‚îî‚îÄ‚îÄ JsonToSheet.ps1          (push JSON back to sheet)
  ‚îî‚îÄ‚îÄ Stats/                       (generated .txt files for OBS)
      ‚îú‚îÄ‚îÄ identity/
      ‚îú‚îÄ‚îÄ core/
      ‚îú‚îÄ‚îÄ combat/
      ‚îî‚îÄ‚îÄ ...
```

---

## üöÄ Setup Instructions

### Step 1: Create Google Service Account

A service account allows the PowerShell scripts to access your Google Sheet without browser authentication.

1. **Go to Google Cloud Console:**
   - Visit: https://console.cloud.google.com/

2. **Create a new project:**
   - Click the project dropdown ‚Üí "New Project"
   - Name it: `Ribbits OBS Stats`
   - Click "Create"

3. **Enable Google Sheets API:**
   - In the search bar, type "Google Sheets API"
   - Click "Google Sheets API" ‚Üí "Enable"

4. **Create Service Account:**
   - Navigate to: "IAM & Admin" ‚Üí "Service Accounts"
   - Click "+ Create Service Account"
   - Name: `ribbits-stat-assistant`
   - ID: `ribbits-stat-assistant` (auto-fills)
   - Click "Create and Continue"
   - Skip "Grant access" and "Grant users access" ‚Üí Click "Done"

5. **Generate JSON Key:**
   - Click on the service account you just created
   - Go to "Keys" tab
   - Click "Add Key" ‚Üí "Create new key"
   - Choose "JSON"
   - Click "Create" ‚Üí downloads `ribbits-stat-assistant-xxxxx.json`

6. **Save the key file:**
   - Rename it to: `service-account.json`
   - Move it to: `F:\Working Files\GitHub Desktop\Ribbitz\OBS Auto Sync\Engine\`
   - ‚ö†Ô∏è **IMPORTANT:** Add this to `.gitignore` - never commit it!

7. **Share your Google Sheet with the service account:**
   - Open your Google Sheet
   - Open the downloaded `service-account.json` and find the `client_email` field
   - It looks like: `ribbits-stat-assistant@project-name.iam.gserviceaccount.com`
   - Copy this email
   - In your Google Sheet, click "Share"
   - Paste the service account email
   - Give it "Editor" permissions
   - Click "Send" (ignore the warning about sending email)

### Step 2: Configure Google Sheet

Your sheet is already set up with the Apps Script! If you need to set up a new sheet:

1. **Open your Google Sheet:**
   - https://docs.google.com/spreadsheets/d/1Vn1Xaq04AWDrrdz-RGO8m6V7SzuFyHrW31e47fnH2v0

2. **Verify Apps Script is installed:**
   - Extensions ‚Üí Apps Script
   - Should see `RibbitsStatAssistant.gs` file

3. **Run initial setup (if not already done):**
   - In Apps Script, select `setupRibbitsSheet` function
   - Click "Run"
   - Authorize when prompted
   - This adds dropdowns to Column C and formats header rows

4. **Add an on-edit trigger:**
   - In Apps Script: Click "Triggers" (clock icon on left)
   - Click "+ Add Trigger"
   - Function: `onEdit`
   - Event source: "From spreadsheet"
   - Event type: "On edit"
   - Click "Save"

### Step 3: Test the Scripts

1. **Open PowerShell as Administrator:**
   - Press Win+X ‚Üí "Windows PowerShell (Admin)"

2. **Navigate to Engine folder:**
   ```powershell
   cd "F:\Working Files\GitHub Desktop\Ribbitz\OBS Auto Sync\Engine"
   ```

3. **Run initial generation:**
   ```powershell
   .\RibbitsStatAssistant.ps1 -Once
   ```

4. **Check for success:**
   - Should see: "Access token acquired"
   - Should see: "Wrote X stat files"
   - Check `Stats\` folder for generated `.txt` files organized by type

---

## üéÆ Usage Workflow

### Normal Gameplay (Continuous Mode)

1. **Start the watcher before your session:**
   ```powershell
   cd "F:\Working Files\GitHub Desktop\Ribbitz\OBS Auto Sync\Engine"
   .\RibbitsStatAssistant.ps1
   ```

2. **Leave it running during gameplay**
   - Polls every 2 seconds (configurable in `ribbits.config.json`)
   - Updates `.txt` files whenever sheet changes
   - OBS automatically shows new values

3. **Stop with Ctrl+C when done**

### AI-Assisted Batch Editing

When you want AI to populate or reorganize many stats at once:

1. **Generate current mapping:**
   ```powershell
   .\RibbitsStatAssistant.ps1 -Once
   ```

2. **Edit `mapping.generated.json` with AI:**
   - AI can fill in values, types, keys, outputFiles
   - Can reorganize, add new stats, etc.

3. **Push changes back to sheet:**
   ```powershell
   .\JsonToSheet.ps1
   ```
   
   **Optional switches:**
   - `-UpdateLabels` - Also update Column A (labels)
   - `-UpdateTypes` - Also update Column C (types)
   - `-UpdateOutputFiles` - Also update Column E (output filenames)
   
   Example:
   ```powershell
   .\JsonToSheet.ps1 -UpdateTypes -UpdateOutputFiles
   ```

4. **Regenerate outputs:**
   ```powershell
   .\RibbitsStatAssistant.ps1 -Once
   ```

5. **Point OBS sources to new files**

---

## üìä Google Sheet Structure

### Columns (A-E):
- **Column A - Label:** Human-friendly name (e.g., "HP Current")
- **Column B - Value:** The actual stat value (e.g., "85")
- **Column C - Type:** Category dropdown (identity/core/combat/etc.)
- **Column D - Key:** Stable ID for filename (e.g., "hp-current")
- **Column E - OutputFile:** Optional override (e.g., "health.txt")

### Header Rows:
- Format: `== Section Name ==`
- Auto-formatted with purple background
- Blank row auto-inserted above

### Example:
```
A               | B   | C        | D           | E
== Identity ==  |     |          |             |
Name            | Ribbitz | identity | name   | character-name.txt
Level           | 15  | core     | level      |
== Combat ==    |     |          |             |
HP Current      | 85  | combat   | hp-current |
HP Max          | 120 | combat   | hp-max     |
```

---

## üé¨ OBS Setup

1. **For each stat you want displayed:**
   - Add Source ‚Üí Text (GDI+)
   - Check "Read from file"
   - Browse to: `F:\Working Files\GitHub Desktop\Ribbitz\OBS Auto Sync\Stats\<type>\<filename>.txt`
   - Format text (font, size, color, etc.)

2. **Filenames are stable!**
   - Based on Key (Column D) or OutputFile (Column E)
   - Won't break if you change labels
   - Only break if you change Key/OutputFile

---

## ‚öôÔ∏è Configuration

### `ribbits.config.json`:

```json
{
  "sheet": {
    "spreadsheetId": "YOUR_SHEET_ID",
    "worksheetName": "Stats",
    "range": "A:E"
  },
  "auth": {
    "mode": "serviceAccount",
    "serviceAccountJsonPath": ".\\service-account.json"
  },
  "output": {
    "folder": "F:\\Working Files\\GitHub Desktop\\Ribbitz\\OBS Auto Sync\\Stats",
    "encoding": "utf8NoBom"
  },
  "generatedMappingPath": ".\\mapping.generated.json",
  "pollSeconds": 2,
  "typeOrder": [
    "identity", "core", "senses", "ability", "save", "skill", 
    "combat", "slots", "spellcasting", "resource", "defense",
    "proficiency", "equipment", "exploration", "companions",
    "features", "feats", "notes", "custom"
  ]
}
```

**Key settings:**
- `pollSeconds`: How often to check sheet (default 2)
- `output.folder`: Where `.txt` files are written
- `typeOrder`: Determines folder organization

---

## üêõ Troubleshooting

### "Service account JSON not found"
- Ensure `service-account.json` is in the `Engine\` folder
- Check the path in `ribbits.config.json`

### "The caller does not have permission"
- Service account email not shared with editor permissions
- Go to your Google Sheet ‚Üí Share ‚Üí Add service account email

### "Sheet not found: Stats"
- Verify worksheet name matches `ribbits.config.json`
- Check `worksheetName` setting

### Token/Authentication Errors
- Token expires after 1 hour but auto-refreshes
- If persistent issues, regenerate service account key

### Files not updating
- Check PowerShell window for errors
- Verify sheet values are actually changing
- Check hash comparison in console output

### OBS not showing updates
- Verify OBS is pointing to correct file path
- Check file exists and has content
- Try refreshing OBS source (hide/unhide)

---

## üîí Security Notes

### ‚ö†Ô∏è Never commit `service-account.json` to Git!

Create a `.gitignore` file:
```
service-account.json
mapping.generated.json
```

### Service account has full edit access
- Only share it with your specific sheet
- Don't share the JSON file with anyone
- Regenerate key if compromised

---

## üìù Advanced Tips

### Performance Optimization
- Increase `pollSeconds` if you don't need 2-second updates
- Use `-Once` flag when not streaming to avoid constant polling

### Custom Stat Types
- Add new types to `typeOrder` in config
- Creates new folders automatically
- Useful for organizing specific campaigns

### Multi-line Stats
- Newlines in Column B are preserved
- Useful for spell lists, notes, etc.

### Cleanup Orphan Files
- Delete Stats folder contents before regenerating
- Removes old files from renamed/deleted stats

---

## üéØ Quick Command Reference

```powershell
# Navigate to scripts
cd "F:\Working Files\GitHub Desktop\Ribbitz\OBS Auto Sync\Engine"

# Generate once (testing)
.\RibbitsStatAssistant.ps1 -Once

# Run continuously (during gameplay)
.\RibbitsStatAssistant.ps1

# Push JSON edits to sheet (values only)
.\JsonToSheet.ps1

# Push JSON edits with labels/types/files
.\JsonToSheet.ps1 -UpdateLabels -UpdateTypes -UpdateOutputFiles
```

---

## üìû Support

If you encounter issues:
1. Check the error message in PowerShell
2. Review this troubleshooting section
3. Verify all setup steps completed
4. Check service account permissions

---

**üê∏ Happy Streaming, Ribbitz! üê∏**
